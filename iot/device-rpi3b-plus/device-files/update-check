#!/bin/bash

SERIAL=$(cat /proc/cpuinfo | grep Serial | sed -n 's/^[^:]*:\(.*\)/\1/p' | xargs)
HOME_DIR=/home/iot

# The last time the update checker issued a reboot to
# start the update process
LAST_REBOOT_FILE=$HOME_DIR/firmware-last-reboot.cfg
REBOOT_COUNT_FILE=$HOME_DIR/firmware-reboots.cfg

# Settings controlling update behaviour
UPDATE_SETTINGS=/run/settings/update.cfg

# When does the update window open
UPDATE_START=$(cat $UPDATE_SETTINGS | grep update-time-start | sed -n 's/[^=]*=\(.*\)/\1/p')
if [ "x$UPDATE_START" == "x" ]; then
	UPDATE_START="02:00"
fi

# When does the update window close
UPDATE_END=$(cat $UPDATE_SETTINGS | grep update-time-end | sed -n 's/[^=]*=\(.*\)/\1/p')
if [ "x$UPDATE_END" == "x" ]; then
	UPDATE_END="06:00"
fi

# How many days to skip before looking for an update again
UPDATE_SKIP_DAYS=$(cat $UPDATE_SETTINGS | grep update-time-skip-days | sed -n 's/[^=]*=\(.*\)/\1/p')
if [ "x$UPDATE_SKIP_DAYS" == "x" ]; then
	UPDATE_SKIP_DAYS=0
fi

# Instant updates (debug feature)
LIVE_CHECK=$(cat $UPDATE_SETTINGS | grep update-live | sed -n 's/[^=]*=\(.*\)/\1/p')
if [ "x$LIVE_CHECK" == "x" ]; then
	LIVE_CHECK=no
fi

# How often the unit publish a heartbeat
HEARTBEAT_RATE=$(cat $UPDATE_SETTINGS | grep heartbeat-rate | sed -n 's/[^=]*=\(.*\)/\1/p')
if [ "x$HEARTBEAT_RATE" == "x" ]; then
	HEARTBEAT_RATE=300
fi

# The last reboot is now, we just started this script
LAST_REBOOT=$(date +%s)

# We will send a heartbeat on startup, so also now
LAST_HEARTBEAT=$LAST_REBOOT

while [ true ]; do

	KEYFILE=/run/keyfile
	BOOT_DIR=/boot/firmware/eplayer

	echo "Crypt-Commission: Key generation"
	/bin/xkey

	# Make commissioning data available under /run
	if [ -f $BOOT_DIR/commission.tar.gz.enc ]; then
		rm -rf /run/commission
		cat $BOOT_DIR/commission.tar.gz.enc | openssl enc -aes-256-cbc -pbkdf2 -d -k "$(cat $KEYFILE)" | tar xz -C /run
	fi

	UPDATE_TIME_START=$(date --date="$UPDATE_START" +%s)
	UPDATE_TIME_END=$(date --date="$UPDATE_END" +%s)
	NOW_TIME_MINUTE=$(date +%s)

	echo "Settings (Update-start: $UPDATE_START, Update-end: $UPDATE_END, Live: $LIVE_CHECK)"

	UPDATE_CHECK_GO=0
	UPDATE_FORCE_FIRST=0
	SKIP_DAYS=$((($NOW_TIME_MINUTE - $LAST_REBOOT) / 86400))

	echo "Skip days (Skip days now: $SKIP_DAYS, Skip days setting: $UPDATE_SKIP_DAYS)"

	if [ $UPDATE_TIME_START -lt $NOW_TIME_MINUTE ] && [ $UPDATE_TIME_END -gt $NOW_TIME_MINUTE ] && [ $SKIP_DAYS -ge $UPDATE_SKIP_DAYS ]; then
		echo "We are inside the update slot..."
		UPDATE_CHECK_GO=1
	fi

	if [ $UPDATE_TIME_START -gt $LAST_REBOOT ] || [ $UPDATE_TIME_END -lt $LAST_REBOOT ]; then
		echo "The last reboot was outside the next update slot..."
		UPDATE_FORCE_FIRST=1
	fi

	if [ "x$UPDATE_CHECK_GO" == "x1" ] || [ "x$LIVE_CHECK" == "xyes" ]; then


		# GREEN LED
		/bin/led-control led0 flash 10

		OLD=$(/bin/offline-version)
		NEW=$(/bin/online-version)
		if [ "x$OLD" != "x$NEW" ]; then
			echo "NEW update available (Old: $OLD, New: $NEW)"
			sync
			reboot
		else
			echo "NO update available (Old: $OLD, New: $NEW)"

			# Stats update on first opportunity in update slot
			if [ "x$UPDATE_CHECK_GO" == "x1" ] && [ "x$UPDATE_FORCE_FIRST" == "x1" ]; then
				echo "We reboot only to update stats (no update available)"
				sync
				reboot
			fi
		fi

	else
		echo "Not time yet to check for update (Now: $NOW_TIME_MINUTE, Update-start: $UPDATE_TIME_START, Update-end: $UPDATE_TIME_END)"
	fi

	# Update Green LED state
	wget -q --spider http://google.com
	RET=$?
	if [ $RET -eq 0 ]; then
		# GREEN LED FLASH 1HZ
		/bin/led-control led0 flash 1
	else
		# GREEN LED OFF
		/bin/led-control led0 off
	fi


	BEAT_DELTA=$((NOW_TIME_MINUTE - LAST_HEARTBEAT))
	if [ $BEAT_DELTA -gt $HEARTBEAT_RATE ] || [ $LAST_HEARTBEAT -eq $LAST_REBOOT ]; then

		# Delay after reboot so we capture actual state
		if [ $LAST_HEARTBEAT -eq $LAST_REBOOT ]; then
			echo "Sleeping 60 seconds after reboot before updating heartbeat..."
			sleep 60
		fi
		
		LAST_HEARTBEAT=$(date +%s)

		echo "Space:"
		df -h			

		echo "Power State: $(vcgencmd get_throttled | cut -d'=' -f2)"
	
		echo "Wifi Hotspots:"
		iwlist wlan0 scan
		
		echo "Network State:"
		ip a
		
		echo "Wifi Connection State:"
		iwconfig wlan0

		echo "Updating heartbeat ..."

		ONLINE=0		
		wget -q --spider http://google.com
		RET=$?
		if [ $RET -eq 0 ]; then
			ONLINE=1
		fi
		
		if [ $ONLINE -eq 1 ] && [ -f /run/commission/.s3cfg-music ] && [ -f /run/commission/cust.cfg ] && [ -f /run/commission/site.cfg ]; then
			T="$(date)"
			L=$(/bin/offline-version)
			O=$(/bin/online-version)
			echo "TIMESTAMP: $T" > /run/.heartbeat
			echo "ONLINE VERSION: $O" >> /run/.heartbeat
			echo "LOCAL VERSION: $L" >> /run/.heartbeat
			echo "REBOOTS: $(cat $REBOOT_DIR/$REBOOT_FILE)" >> /run/.heartbeat
			echo "POWER: $(vcgencmd get_throttled | cut -d'=' -f2)" >> /run/.heartbeat
			echo "FW: $(cat /home/eplayer/.firmware_version)" >> /run/.heartbeat

			s3cmd -q -f --config /run/commission/.s3cfg-ctrl put --no-preserve /run/.heartbeat s3://ep-stats/$(cat /run/commission/cust.cfg)/$(cat /run/commission/site.cfg)/$SERIAL-heartbeat.txt
			
			journalctl -u ep -a -n 50 > /run/.heartbeat

			s3cmd -q -f --config /run/commission/.s3cfg-ctrl put --no-preserve /run/.heartbeat s3://ep-stats/$(cat /run/commission/cust.cfg)/$(cat /run/commission/site.cfg)/$SERIAL-ep.txt
			
			cat $REBOOT_DIR/$STAT_SOURCE | tail -n10 > /run/.heartbeat

			s3cmd -q -f --config /run/commission/.s3cfg-ctrl put --no-preserve /run/.heartbeat s3://ep-stats/$(cat /run/commission/cust.cfg)/$(cat /run/commission/site.cfg)/$SERIAL-player.txt
		fi		
	else
		echo "Not ready to update heartbeat (Delta: $BEAT_DELTA, Rate: $HEARTBEAT_RATE)"
	fi

	# Cleanup
	rm -rf /run/commission
	rm -rf $KEYFILE
	
	sleep 300
done

